!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-dataflow"),require("vega-expression"),require("vega-statistics"),require("d3-color"),require("d3-array"),require("d3-format"),require("d3-time-format"),require("vega-scale"),require("vega-scenegraph"),require("vega-event-selector")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-dataflow","vega-expression","vega-statistics","d3-color","d3-array","d3-format","d3-time-format","vega-scale","vega-scenegraph","vega-event-selector"],t):t(e.vega=e.vega||{},e.vega,e.vega,e.vega,e.vega,e.d3,e.d3,e.d3,e.d3,e.vega,e.vega,e.vega)}(this,function(e,t,n,r,a,i,o,l,u,s,d,f){"use strict";function c(e){return+e||0}function p(e){return{top:e,bottom:e,left:e,right:e}}function g(e,n){t.error(e+' for "outer" push: '+t.stringValue(n))}function h(e,t,n){var r=e+":"+n,a=yt[r];return a&&a[0]===t||(yt[r]=a=[t,t(n)]),a[1]}function m(e,t){return h("timeFormat",u.timeFormat,t)(e)}function v(e,t,n){return bt.setMonth(e),bt.setDate(t),m(bt,n)}function y(e,t,n){try{e[t].apply(e,["EXPRESSION"].concat([].slice.call(n)))}catch(t){e.warn(t)}return n[n.length-1]}function b(e,n){var r;return t.isFunction(e)?e:t.isString(e)?(r=n.scales[e])&&r.value:void 0}function x(e,t,n){var r=wt+n;if(!t.hasOwnProperty(r))try{t[r]=e.scaleRef(n)}catch(e){}}function k(e,t,n,r){if(t[0].type===kt)x(n,r,t[0].value);else if(t[0].type===St)for(e in n.scales)x(n,r,e)}function S(e){return function(t,n,r){var a=b(t,(r||this).context);return a&&a.path[e](n)}}function R(e){var t=this.context.data[e];return t?t.values.value:[]}function w(e,n,r,a){n[0].type!==kt&&t.error("First argument to data functions must be a string literal.");var i=n[0].value,o=zt+i;a.hasOwnProperty(o)||(a[o]=r.getData(i).tuplesRef())}function z(e){return e.data}function O(e,t){var n=R.call(t,e);return n.root&&n.root.lookup||Dt}function P(e,n){return e===n||e!==e&&n!==n||!(!t.isArray(e)||!t.isArray(n)||e.length!==n.length)&&j(e,n)}function j(e,t){for(var n=0,r=e.length;n<r;++n)if(!P(e[n],t[n]))return!1;return!0}function D(e){return function(t){for(var n in e)if(!P(t[n],e[n]))return!1;return!0}}function $(e,n){for(var r,a=n.fields,i=n.values,o=n.getter||(n.getter=[]),l=a.length,u=0;u<l;++u)if(o[u]=o[u]||t.field(a[u]),r=o[u](e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(i[u])&&(i[u]=t.toNumber(i[u])),n[Et+a[u]]){if(t.isDate(i[u][0])&&(i[u]=i[u].map(t.toNumber)),!$t(r,i[u],!0,!1))return!1}else if(r!==i[u])return!1;return!0}function E(e,n){for(var r,a,i,o=n.intervals,l=o.length,u=0;u<l;++u){if(a=o[u].extent,r=o[u].getter||(o[u].getter=t.field(o[u].field)),i=r(e),!a||a[0]===a[1])return!1;if(t.isDate(i)&&(i=t.toNumber(i)),t.isDate(a[0])&&(a=o[u].extent=a.map(t.toNumber)),t.isNumber(a[0])&&!$t(i,a))return!1;if(t.isString(a[0])&&a.indexOf(i)<0)return!1}return!0}function _(e,t,n,r){for(var a,i,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=s?s[Ft]&&s[Ft].value:void 0,c=n===_t,p=d.length,g=0;g<p;++g)if(a=d[g],f&&c){if(i=i||{},-1===(o=i[l=a.unit]||0))continue;if(u=r(t,a),i[l]=u?-1:++o,u&&1===f.size)return!0;if(!u&&o===f.get(l).count)return!1}else if(u=r(t,a),c^u)return u;return p&&c}function V(e,t,n){return _.call(this,e,t,n,$)}function F(e,n,r,a){n[0].type!==kt&&t.error("First argument to indata must be a string literal.");var i=n[0].value,o=n.length>=2&&n[n.length-1].value,l=Rt+"unit";o!==_t||a.hasOwnProperty(l)||(a[l]=r.getData(i).indataRef(r,"unit")),w(e,n,r,a)}function A(e,t,n,r){var a,i,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=s?s[Ft]&&s[Ft].value:void 0,c=d[0],p=0;if(c){for(a=t?c.encodings.length:c.fields.length;p<a;++p)if(t&&c.encodings[p]===t||n&&c.fields[p]===n){i=p,l=c[Et+c.fields[p]];break}return f&&1===f.size&&(r=Vt),f&&r===_t?(u=d.reduce(function(e,t){return(e[t.unit]||(e[t.unit]=[])).push({unit:t.unit,value:t.values[i]}),e},{}),o=Object.keys(u).map(function(e){return{unit:e,value:l?L(u[e],Vt):M(u[e],Vt)}})):o=d.map(function(e){return{unit:e.unit,value:e.values[i]}}),l?L(o,r):M(o,r)}}function M(e,t){for(var n,r,a,i,o={},l=0,u={},s=[],d=0,f=e.length;d<f;++d)r=(n=e[d]).unit,i=n.value,o[r]||(o[r]=++l),(a=u[i])||(u[i]=a={value:i,units:{},count:0}),a.units[r]||(a.units[r]=++a.count);for(i in u)a=u[i],t===_t&&a.count!==l||s.push(a.value);return s.length?s:void 0}function L(e,n){for(var r,a,i,o,l=n===_t?C:W,u=0,s=e.length;u<s;++u)r=e[u].value,t.isDate(r[0])&&(r=r.map(t.toNumber)),(i=r[0])>(o=r[1])&&(o=r[0],i=r[1]),a=a?l(a,i,o):[i,o];return a&&a.length&&+a[0]!=+a[1]?a:void 0}function W(e,t,n){return e[0]>t&&(e[0]=t),e[1]<n&&(e[1]=n),e}function C(e,t,n){return n<e[0]||e[1]<t?[]:(e[0]<t&&(e[0]=t),e[1]>n&&(e[1]=n),e)}function q(e,t,n){return 1===arguments.length?At[e]:(At[e]=t,n&&(Ct[e]=n),Bt&&(Bt.functions[e]=Wt+e),this)}function B(e){return e===Tt?Ut:e||Ut}function N(e,n){return(e.merge?U:e.stream?T:e.type?I:t.error("Invalid stream specification: "+t.stringValue(e)))(e,n)}function U(e,t){var n=X({merge:e.merge.map(function(e){return N(e,t)})},e,t);return t.addStream(n).id}function T(e,t){var n=X({stream:N(e.stream,t)},e,t);return t.addStream(n).id}function I(e,t){var n=t.event(B(e.source),e.type),r=X({stream:n},e,t);return 1===Object.keys(r).length?n:t.addStream(r).id}function X(e,n,r){var a=n.between;return a&&(2!==a.length&&t.error('Stream "between" parameter must have 2 entries: '+t.stringValue(n)),e.between=[N(a[0],r),N(a[1],r)]),a=n.filter?t.array(n.filter):[],(n.marktype||n.markname||n.markrole)&&a.push(H(n.marktype,n.markname,n.markrole)),n.source===Tt&&a.push("inScope(event.item)"),a.length&&(e.filter=Nt("("+a.join(")&&(")+")").$expr),null!=(a=n.throttle)&&(e.throttle=+a),null!=(a=n.debounce)&&(e.debounce=+a),n.consume&&(e.consume=!0),e}function H(e,t,n){var r="event.item";return r+(e&&"*"!==e?"&&"+r+".mark.marktype==='"+e+"'":"")+(n?"&&"+r+".mark.role==='"+n+"'":"")+(t?"&&"+r+".mark.name==='"+t+"'":"")}function Y(e,t,n,r){this.id=-1,this.type=e,this.value=t,this.params=n,r&&(this.parent=r)}function G(e,t,n,r){return new Y(e,t,n,r)}function J(e,t){return G("operator",e,t)}function K(e){var t={$ref:e.id};return e.id<0&&(e.refs=e.refs||[]).push(t),t}function Q(e,t){return t?{$field:e,$name:t}:{$field:e}}function Z(e,t){return{$compare:e,$order:t}}function ee(e,t){var n={$key:e};return t&&(n.$flat=!0),n}function te(e){return t.isObject(e)?(e.order===Kt?"-":"+")+ne(e.op,e.field):""}function ne(e,t){return(e&&e.signal?"$"+e.signal:e||"")+(e&&t?"_":"")+(t&&t.signal?"$"+t.signal:t||"")}function re(e){return e&&e.signal}function ae(e,t){return null!=e?e:t}function ie(e){return function(t,n,r){return G(e,n,t||void 0,r)}}function oe(e){return jn.hasOwnProperty(e)}function le(e){return"quantile"===e}function ue(e,n){var r=e.type||"linear";Pn.hasOwnProperty(r)||t.error("Unrecognized scale type: "+t.stringValue(r)),n.addScale(e.name,{type:r,domain:void 0})}function se(e,t){var n,r=t.getScale(e.name).params;r.domain=pe(e.domain,e,t),null!=e.range&&(r.range=we(e,t,r)),null!=e.interpolate&&Re(e.interpolate,r),null!=e.nice&&Se(e.nice,r);for(n in e)r.hasOwnProperty(n)||"name"===n||(r[n]=de(e[n],t))}function de(e,n){return t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported object: "+t.stringValue(e)):e}function fe(e,t){return e.signal?t.signalRef(e.signal):e.map(function(e){return de(e,t)})}function ce(e){t.error("Can not find data set: "+t.stringValue(e))}function pe(e,n,r){if(e)return e.signal?r.signalRef(e.signal):(t.isArray(e)?ge:e.fields?me:he)(e,n,r);null==n.domainMin&&null==n.domainMax||t.error("No scale domain defined for domainMin/domainMax to override.")}function ge(e,t,n){return e.map(function(e){return de(e,n)})}function he(e,t,n){var r=n.getData(e.data);return r||ce(e.data),oe(t.type)?r.valuesRef(n,e.field,be(e.sort,!1)):le(t.type)?r.domainRef(n,e.field):r.extentRef(n,e.field)}function me(e,n,r){var a=e.data,i=e.fields.reduce(function(e,n){return n=t.isString(n)?{data:a,field:n}:t.isArray(n)||n.signal?ve(n,r):n,e.push(n),e},[]);return(oe(n.type)?ye:le(n.type)?xe:ke)(e,r,i)}function ve(e,n){var r="_:vega:_"+zn++,a=tn({});return t.isArray(e)?a.value={$ingest:e}:e.signal&&n.signalRef("setdata("+t.stringValue(r)+","+e.signal+")"),n.addDataPipeline(r,[a,kn({})]),{data:r,field:"data"}}function ye(e,t,n){var r,a,i,o;return r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.countsRef(t,e.field)}),a=t.add(Qt({groupby:Jt,ops:["sum"],fields:[t.fieldRef("count")],as:["count"],pulse:r})),i=t.add(tn({pulse:K(a)})),o=t.add(wn({field:Jt,sort:t.sortRef(be(e.sort,!0)),pulse:K(i)})),K(o)}function be(e,n){return e&&(e.field||e.op?e.field||"count"===e.op?n&&e.field?t.error("Multiple domain scales can not sort by field."):n&&e.op&&"count"!==e.op&&t.error("Multiple domain scales support op count only."):t.error("No field provided for sort aggregate op: "+e.op):t.isObject(e)?e.field="key":e={field:"key"}),e}function xe(e,t,n){var r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.domainRef(t,e.field)});return K(t.add(cn({values:r})))}function ke(e,t,n){var r=n.map(function(e){var n=t.getData(e.data);return n||ce(e.data),n.extentRef(t,e.field)});return K(t.add(fn({extents:r})))}function Se(e,n){n.nice=t.isObject(e)?{interval:de(e.interval),step:de(e.step)}:de(e)}function Re(e,t){t.interpolate=de(e.type||e),null!=e.gamma&&(t.interpolateGamma=de(e.gamma))}function we(e,n,r){var a=e.range,i=n.config.range;if(a.signal)return n.signalRef(a.signal);if(t.isString(a)){if(i&&i.hasOwnProperty(a))return e=t.extend({},e,{range:i[a]}),we(e,n,r);"width"===a?a=[0,{signal:"width"}]:"height"===a?a=oe(e.type)?[0,{signal:"height"}]:[{signal:"height"},0]:t.error("Unrecognized scale range value: "+t.stringValue(a))}else{if(a.scheme)return r.scheme=de(a.scheme,n),a.extent&&(r.schemeExtent=fe(a.extent,n)),void(a.count&&(r.schemeCount=de(a.count,n)));if(a.step)return void(r.rangeStep=de(a.step,n));if(oe(e.type)&&!t.isArray(a))return pe(a,e,n);t.isArray(a)||t.error("Unsupported range type: "+t.stringValue(a))}return a.map(function(e){return de(e,n)})}function ze(e,n){return t.isArray(e)?e.map(function(e){return ze(e,n)}):t.isObject(e)?e.signal?n.signalRef(e.signal):t.error("Unsupported parameter object: "+t.stringValue(e)):e}function Oe(e,n,r,a){var i,o,l;if(e.signal)i="datum",l=Nn(e.signal,n,r,a);else if(e.group||e.parent){for(o=Math.max(1,e.level||1),i="item";o-- >0;)i+=".mark.group";e.parent?(l=e.parent,i+=".datum"):l=e.group}else e.datum?(i="datum",l=e.datum):t.error("Invalid field reference: "+t.stringValue(e));return e.signal||(t.isString(l)?(a[l]=1,l=t.splitAccessPath(l).map(t.stringValue).join("][")):l=Oe(l,n,r,a)),i+"["+l+"]"}function Pe(e,n){if(!t.isString(e))return-1;var r=n.scaleType(e);return"band"===r||"point"===r?1:0}function je(e,n,r,a){var i;if(t.isString(e))i=wt+e,r.hasOwnProperty(i)||(r[i]=n.scaleRef(e)),i=t.stringValue(i);else{for(i in n.scales)r[wt+i]=n.scaleRef(i);i=t.stringValue(wt)+"+"+(e.signal?"("+Nn(e.signal,n,r,a)+")":Un(e,n,r,a))}return"_["+i+"]"}function De(e,n,r,a){var i,o,l,u={},s="var o=item,datum=o.datum,$;";for(i in e)o=e[i],t.isArray(o)?s+=Gn(i,o,a,r,u):(l=Hn(i,o,a,r,u),s+=Yn("o",i,l));return s+=qn(e,n),s+="return 1;",{$expr:s,$fields:Object.keys(u),$output:Object.keys(e)}}function $e(e){return t.isObject(e)?e:{value:e}}function Ee(e,n,r){return null!=r?(e[n]=t.isObject(r)&&!t.isArray(r)?r:{value:r},1):0}function _e(e,n,r){for(var a in n)r&&r.hasOwnProperty(a)||(e[a]=t.extend(e[a]||{},n[a]));return e}function Ve(e,t,n,r,a,i){var o,l;(i=i||{}).encoders={$encode:o={}},e=Fe(e,t,n,r,a.config);for(l in e)o[l]=De(e[l],t,i,a);return i}function Fe(e,n,r,a,i){var o,l,u={};"legend"!=r&&0!==String(r).indexOf("axis")||(r=null),l=r===Kn?i.group:r===Jn?t.extend({},i.mark,i[n]):null;for(o in l)Ae(o,e)||("fill"===o||"stroke"===o)&&(Ae("fill",e)||Ae("stroke",e))||(u[o]={value:l[o]});return t.array(a).forEach(function(t){var n=i.style&&i.style[t];for(var r in n)Ae(r,e)||(u[r]={value:n[r]})}),e=t.extend({},e),e.enter=t.extend(u,e.enter),e}function Ae(e,t){return t&&(t.enter&&t.enter[e]||t.update&&t.update[e])}function Me(e,t,n){var r,a,i,o={};for(a=0,i=e.params.length;a<i;++a)o[(r=e.params[a]).name]=Le(r,t,n);return o}function Le(e,n,r){var a=e.type,i=n[e.name];if("index"===a)return Ce(e,n,r);{if(void 0!==i)return"param"===a?qe(e,n,r):"projection"===a?r.projectionRef(n[e.name]):e.array&&!re(i)?i.map(function(t){return We(e,t,r)}):We(e,i,r);e.required&&t.error("Missing required "+t.stringValue(n.type)+" parameter: "+t.stringValue(e.name))}}function We(e,n,r){var a=e.type;if(re(n))return Ie(a)?t.error("Expression references can not be signals."):Xe(a)?r.fieldRef(n):He(a)?r.compareRef(n):r.signalRef(n.signal);var i=e.expr||Xe(a);return i&&Ne(n)?Nt(n.expr,r):i&&Ue(n)?Q(n.field):Ie(a)?Nt(n,r):Te(a)?K(r.getData(n).values):Xe(a)?Q(n):He(a)?r.compareRef(n):n}function Ce(e,n,r){return t.isString(n.from)||t.error('Lookup "from" parameter must be a string literal.'),r.getData(n.from).lookupRef(r,n.key)}function qe(e,n,r){var a=n[e.name];return e.array?(t.isArray(a)||t.error("Expected an array of sub-parameters. Instead: "+t.stringValue(a)),a.map(function(t){return Be(e,t,r)})):Be(e,a,r)}function Be(e,n,r){var a,i,o,l,u;for(l=0,u=e.params.length;l<u;++l){i=e.params[l];for(o in i.key)if(i.key[o]!==n[o]){i=null;break}if(i)break}return i||t.error("Unsupported parameter: "+t.stringValue(n)),a=t.extend(Me(i,n,r),i.key),K(r.add(gn(a)))}function Ne(e){return e&&e.expr}function Ue(e){return e&&e.field}function Te(e){return"data"===e}function Ie(e){return"expr"===e}function Xe(e){return"field"===e}function He(e){return"compare"===e}function Ye(e,t,n,r,a){this.scope=e,this.input=t,this.output=n,this.values=r,this.aggregate=a,this.index={}}function Ge(e){return t.isString(e)?e:null}function Je(e,t,n){var r,a=ne(n.op,n.field);if(t.ops){for(var i=0,o=t.as.length;i<o;++i)if(t.as[i]===a)return}else t.ops=["count"],t.fields=[null],t.as=["count"];n.op&&(t.ops.push((r=n.op.signal)?e.signalRef(r):n.op),t.fields.push(e.fieldRef(n.field)),t.as.push(a))}function Ke(e,t,n,r,a,i,o){var l,u,s=t[n]||(t[n]={}),d=te(i),f=Ge(a);if(null!=f&&(e=t.scope,l=s[f+=d?"|"+d:""]),!l){var c=i?{field:Jt,pulse:t.countsRef(e,a,i)}:{field:e.fieldRef(a),pulse:K(t.output)};d&&(c.sort=e.sortRef(i)),u=e.add(G(r,void 0,c)),o&&(t.index[a]=u),l=K(u),null!=f&&(s[f]=l)}return l}function Qe(e,t,n){var r=et(t,n[1].encode,"fontSize",Fn);if(e.size)return{$expr:"Math.max(Math.ceil(Math.sqrt(_.scale(datum))),"+r+")"};var a=et(t,n[0].encode,"size");return Math.max(Math.ceil(Math.sqrt(a)),r)}function Ze(e){var t={};return Ee(t,"fill",e.fillColor)+Ee(t,"stroke",e.strokeColor)+Ee(t,"strokeWidth",e.strokeWidth)+Ee(t,"strokeDash",e.strokeDash)+Ee(t,"cornerRadius",e.cornerRadius)?t:void 0}function et(e,t,n,r){var a=t&&(t.update&&t.update[n]||t.enter&&t.enter[n]);return+(a?a.value:r&&(a=e.config.style[r])&&a[n])}function tt(e,n,r,a){var i,o,l,u,s,d,f=e.text,c=e.orient||n.orient,p=e.anchor||n.anchor,g=c===En||c===$n?-1:1,h=c===$n||c===_n,m={group:h?"width":"height"},v={};return v.enter=i={opacity:{value:0}},Ee(i,"fill",n.color),Ee(i,"font",n.font),Ee(i,"fontSize",n.fontSize),Ee(i,"fontWeight",n.fontWeight),v.exit={opacity:{value:0}},v.update=o={opacity:{value:1},text:t.isObject(f)?f:{value:f+""},offset:$e((null!=e.offset?e.offset:n.offset)||0)},"start"===p?(s=0,d="left"):"end"===p?(s=1,d="right"):(s=.5,d="center"),l={field:m,mult:s},u=g<0?{value:0}:h?{field:{group:"height"}}:{field:{group:"width"}},h?(o.x=l,o.y=u,o.angle={value:0},o.baseline={value:c===$n?"bottom":"top"}):(o.x=u,o.y=l,o.angle={value:90*g},o.baseline={value:"bottom"}),o.align={value:d},o.limit={field:m},Ee(o,"angle",n.angle),Ee(o,"baseline",n.baseline),Ee(o,"limit",n.limit),Zn(tr,Qn,e.style||An,null,a,v,r)}function nt(e,t){var n=[];e.transform&&e.transform.forEach(function(e){n.push(dr(e,t))}),e.on&&e.on.forEach(function(n){hr(n,t,e.name)}),t.addDataPipeline(e.name,rt(e,t,n))}function rt(e,n,r){var a,i,o,l,u,s=[],d=null,f=!1,c=!1;for(e.values?s.push(d=at({$ingest:e.values,$format:e.format})):e.url?s.push(d=at({$request:e.url,$format:e.format})):e.source&&(d=a=t.array(e.source).map(function(e){return K(n.getData(e).output)}),s.push(null)),i=0,o=r.length;i<o;++i)u=(l=r[i]).metadata,d||u.source||s.push(d=at()),s.push(l),u.generates&&(c=!0),u.modifies&&!c&&(f=!0),u.source?d=l:u.changes&&(d=null);return a&&(o=a.length-1,s[0]=yn({derive:f,pulse:o?a:a[0]}),(f||o)&&s.splice(1,0,at())),d||s.push(at()),s.push(kn({})),s}function at(e){var t=tn({},e);return t.metadata={source:!0},t}function it(e,t){return{scale:e.scale,range:t}}function ot(e,t,n,r,a){return{signal:'flush(range("'+e+'"), scale("'+e+'", datum.value), '+t+","+n+","+r+","+a+")"}}function lt(e,n){var r,a,i,o,l,u=n.config;return n.background=e.background||u.background,n.eventConfig=u.events,l=K(n.root=n.add(J())),n.addSignal("width",e.width||0),n.addSignal("height",e.height||0),n.addSignal("padding",ht(e.padding,u)),n.addSignal("autosize",gt(e.autosize,u)),t.array(e.signals).forEach(function(e){Pr[e.name]||vt(e,n)}),a=n.add(tn()),i=_e({enter:{x:{value:0},y:{value:0}},update:{width:{signal:"width"},height:{signal:"height"}}},e.encode),i=n.add(an(Ve(i,er,Kn,e.style,n,{pulse:K(a)}))),o=n.add(Rn({layout:n.objectProperty(e.layout),legendMargin:u.legendMargin,autosize:n.signalRef("autosize"),mark:l,pulse:K(i)})),n.operators.pop(),n.pushState(K(i),K(o),null),Or(e,n,!0),n.operators.push(o),r=n.add(en({mark:l,pulse:K(o)})),r=n.add(bn({pulse:K(r)})),r=n.add(kn({pulse:K(r)})),n.addData("root",new Ye(n,a,a,r)),n}function ut(e){this.config=e,this.bindings=[],this.field={},this.signals={},this.lambdas={},this.scales={},this.events={},this.data={},this.streams=[],this.updates=[],this.operators=[],this.background=null,this.eventConfig=null,this._id=0,this._subid=0,this._nextsub=[0],this._parent=[],this._encode=[],this._lookup=[],this._markpath=[]}function st(e){this.config=e.config,this.field=Object.create(e.field),this.signals=Object.create(e.signals),this.lambdas=Object.create(e.lambdas),this.scales=Object.create(e.scales),this.events=Object.create(e.events),this.data=Object.create(e.data),this.streams=[],this.updates=[],this.operators=[],this._id=0,this._subid=++e._nextsub[0],this._nextsub=e._nextsub,this._parent=e._parent.slice(),this._encode=e._encode.slice(),this._lookup=e._lookup.slice(),this._markpath=e._markpath}function dt(e){return(t.isArray(e)?ft:ct)(e)}function ft(e){for(var n,r="[",a=0,i=e.length;a<i;++a)n=e[a],r+=(a>0?",":"")+(t.isObject(n)?n.signal||dt(n):t.stringValue(n));return r+"]"}function ct(e){var n,r,a="{",i=0;for(n in e)r=e[n],a+=(++i>1?",":"")+t.stringValue(n)+":"+(t.isObject(r)?r.signal||dt(r):t.stringValue(r));return a+"}"}function pt(){return{padding:0,autosize:"pad",background:null,events:{defaults:{allow:["wheel"]}},group:null,mark:null,arc:{fill:Vr},area:{fill:Vr},image:null,line:{stroke:Vr,strokeWidth:_r},path:{stroke:Vr},rect:{fill:Vr},rule:{stroke:Fr},shape:{stroke:Vr},symbol:{fill:Vr,size:64},text:{fill:Fr,font:$r,fontSize:11},style:{"guide-label":{fill:Fr,font:$r,fontSize:10},"guide-title":{fill:Fr,font:$r,fontSize:11,fontWeight:"bold"},"group-title":{fill:Fr,font:$r,fontSize:13,fontWeight:"bold"},point:{size:Er,strokeWidth:_r,shape:"circle"},circle:{size:Er,strokeWidth:_r},square:{size:Er,strokeWidth:_r,shape:"square"},cell:{fill:"transparent",stroke:Mr}},axis:{minExtent:0,maxExtent:200,bandPosition:.5,domain:!0,domainWidth:1,domainColor:Ar,grid:!1,gridWidth:1,gridColor:Mr,gridDash:[],gridOpacity:1,labels:!0,labelAngle:0,labelLimit:180,labelPadding:2,ticks:!0,tickColor:Ar,tickOffset:0,tickRound:!0,tickSize:5,tickWidth:1,titleAlign:"center",titlePadding:4},axisBand:{tickOffset:-1},legend:{orient:"right",offset:18,padding:0,entryPadding:5,titlePadding:5,gradientWidth:100,gradientHeight:20,gradientStrokeColor:Mr,gradientStrokeWidth:0,gradientLabelBaseline:"top",gradientLabelOffset:2,labelAlign:"left",labelBaseline:"middle",labelOffset:8,labelLimit:160,symbolType:"circle",symbolSize:100,symbolFillColor:"transparent",symbolStrokeColor:Ar,symbolStrokeWidth:1.5,titleAlign:"left",titleBaseline:"top",titleLimit:180},title:{orient:"top",anchor:"middle",offset:4},range:{category:{scheme:"tableau10"},ordinal:{scheme:"blues",extent:[.2,1]},heatmap:{scheme:"viridis"},ramp:{scheme:"blues",extent:[.2,1]},diverging:{scheme:"blueorange"},symbol:["circle","square","triangle-up","cross","diamond","triangle-right","triangle-down","triangle-left"]}}}var gt=function(e,n){return e=e||n.autosize,t.isObject(e)?e:(e=e||"pad",{type:e})},ht=function(e,n){return e=e||n.padding,t.isObject(e)?{top:c(e.top),bottom:c(e.bottom),left:c(e.left),right:c(e.right)}:p(c(e))},mt=["value","update","react","bind"],vt=function(e,t){var n=e.name;if("outer"===e.push)t.signals[n]||g("No prior signal definition",n),mt.forEach(function(t){void 0!==e[t]&&g("Invalid property ",t)});else{var r=t.addSignal(n,e.value);!1===e.react&&(r.react=!1),e.bind&&t.addBinding(n,e.bind)}},yt={},bt=new Date(2e3,0,1),xt="undefined"!=typeof window&&window||null,kt="Literal",St="Identifier",Rt="@",wt="%",zt=":",Ot=S("area"),Pt=S("bounds"),jt=S("centroid"),Dt={},$t=function(e,t,n,r){var a,i=t[0],o=t[t.length-1];return i>o&&(a=i,i=o,o=a),n=void 0===n||n,r=void 0===r||r,(n?i<=e:i<e)&&(r?e<=o:e<o)},Et="bin_",_t="intersect",Vt="union",Ft="index:unit",At={random:function(){return a.random()},isArray:t.isArray,isBoolean:t.isBoolean,isDate:t.isDate,isNumber:t.isNumber,isObject:t.isObject,isRegExp:t.isRegExp,isString:t.isString,isTuple:n.isTuple,toBoolean:t.toBoolean,toDate:t.toDate,toNumber:t.toNumber,toString:t.toString,pad:t.pad,peek:t.peek,truncate:t.truncate,rgb:i.rgb,lab:i.lab,hcl:i.hcl,hsl:i.hsl,sequence:o.range,format:function(e,t){return h("format",l.format,t)(e)},utcFormat:function(e,t){return h("utcFormat",u.utcFormat,t)(e)},utcParse:function(e,t){return h("utcParse",u.utcParse,t)(e)},timeFormat:m,timeParse:function(e,t){return h("timeParse",u.timeParse,t)(e)},monthFormat:function(e){return v(e,1,"%B")},monthAbbrevFormat:function(e){return v(e,1,"%b")},dayFormat:function(e){return v(0,2+e,"%A")},dayAbbrevFormat:function(e){return v(0,2+e,"%a")},quarter:function(e){return 1+~~(new Date(e).getMonth()/3)},utcquarter:function(e){return 1+~~(new Date(e).getUTCMonth()/3)},warn:function(){return y(this.context.dataflow,"warn",arguments)},info:function(){return y(this.context.dataflow,"info",arguments)},debug:function(){return y(this.context.dataflow,"debug",arguments)},inScope:function(e){var t=this.context.group,n=!1;if(t)for(;e;){if(e===t){n=!0;break}e=e.mark.group}return n},clampRange:function(e,t,n){var r,a=e[0],i=e[1];return i<a&&(r=i,i=a,a=r),(r=i-a)>=n-t?[t,n]:[Math.min(Math.max(a,t),n-r),Math.min(Math.max(i,r),n)]},pinchDistance:function(e){var t=e.touches,n=t[0].clientX-t[1].clientX,r=t[0].clientY-t[1].clientY;return Math.sqrt(n*n+r*r)},pinchAngle:function(e){var t=e.touches;return Math.atan2(t[0].clientY-t[1].clientY,t[0].clientX-t[1].clientX)},screen:function(){return xt?xt.screen:{}},containerSize:function(){var e=this.context.dataflow,t=e.container&&e.container();return t?[t.clientWidth,t.clientHeight]:[void 0,void 0]},windowSize:function(){return xt?[xt.innerWidth,xt.innerHeight]:[void 0,void 0]},span:function(e){return e[e.length-1]-e[0]||0},flush:function(e,n,r,a,i,o){var l=Math.abs(n-e[0]),u=Math.abs(t.peek(e)-n);return l<u&&l<=r?a:u<=r?i:o},bandspace:function(e,t,n){return s.bandSpace(e||0,t||0,n||0)},inrange:$t,setdata:function(e,n){var r=this.context.dataflow,a=this.context.data[e].input;return r.pulse(a,r.changeset().remove(t.truthy).insert(n)),1},panLinear:t.panLinear,panLog:t.panLog,panPow:t.panPow,zoomLinear:t.zoomLinear,zoomLog:t.zoomLog,zoomPow:t.zoomPow,encode:function(e,t,n){if(e){var r=this.context.dataflow,a=e.mark.source;r.pulse(a,r.changeset().encode(e,t))}return void 0!==n?n:e},modify:function(e,r,a,i,o,l){var u,s,d=this.context.dataflow,f=this.context.data[e],c=f.input,p=f.changes,g=d.stamp();if(!1===d._trigger||!(c.value.length||r||i))return 0;if((!p||p.stamp<g)&&(f.changes=p=d.changeset(),p.stamp=g,d.runAfter(function(){f.modified=!0,d.pulse(c,p).run()},!0)),a&&(u=!0===a?t.truthy:t.isArray(a)||n.isTuple(a)?a:D(a),p.remove(u)),r&&p.insert(r),i&&(u=D(i),c.value.some(u)?p.remove(u):p.insert(i)),o)for(s in l)p.modify(o,s,l[s]);return 1}},Mt=["view","item","group","xy","x","y"],Lt="event.vega.",Wt="this.",Ct={};q("bandwidth",function(e,t){var n=b(e,(t||this).context);return n&&n.bandwidth?n.bandwidth():0},k),q("copy",function(e,t){var n=b(e,(t||this).context);return n?n.copy():void 0},k),q("domain",function(e,t){var n=b(e,(t||this).context);return n?n.domain():[]},k),q("range",function(e,t){var n=b(e,(t||this).context);return n&&n.range?n.range():[]},k),q("invert",function(e,n,r){var a=b(e,(r||this).context);return a?t.isArray(n)?(a.invertRange||a.invert)(n):(a.invert||a.invertExtent)(n):void 0},k),q("scale",function(e,t,n){var r=b(e,(n||this).context);return r?r(t):void 0},k),q("gradient",function(e,t,n,r){var a=d.Gradient(t,n),i=e.domain(),o=i[0],l=i[i.length-1],u=s.scaleFraction(e,o,l);e.ticks&&(o!==(i=e.ticks(+r||15))[0]&&i.unshift(o),l!==i[i.length-1]&&i.push(l));for(var f=0,c=i.length;f<c;++f)a.stop(u(i[f]),e(i[f]));return a},k),q("geoArea",Ot,k),q("geoBounds",Pt,k),q("geoCentroid",jt,k),q("indata",function(e,t,n){var r=this.context.data[e]["index:"+t],a=r?r.value.get(n):void 0;return a?a.count:a},function(e,n,r,a){n[0].type!==kt&&t.error("First argument to indata must be a string literal."),n[1].type!==kt&&t.error("Second argument to indata must be a string literal.");var i=n[0].value,o=n[1].value,l=Rt+o;a.hasOwnProperty(l)||(a[l]=r.getData(i).indataRef(r,o))}),q("data",R,w),q("vlSingle",V,w),q("vlSingleDomain",A,w),q("vlMulti",V,F),q("vlMultiDomain",A,F),q("vlInterval",function(e,t,n){return _.call(this,e,t,n,E)},w),q("vlIntervalDomain",function(e,t,n,r){var a,i,o,l,u,s=this.context.data[e],d=s?s.values.value:[],f=d[0],c=0;if(f){for(a=f.intervals.length;c<a;++c)if(i=f.intervals[c],t&&i.encoding===t||n&&i.field===n){if(!i.extent)return;o=c,u=i.extent.length>2;break}return l=d.reduce(function(e,t){var n=t.intervals[o].extent,r=u?n.map(function(e){return{unit:t.unit,value:e}}):{unit:t.unit,value:n};return u?e.push.apply(e,r):e.push(r),e},[]),u?M(l,r):L(l,r)}},w),q("treePath",function(e,t,n){var r=O(e,this),a=r[t],i=r[n];return a&&i?a.path(i).map(z):void 0},w),q("treeAncestors",function(e,t){var n=O(e,this)[t];return n?n.ancestors().map(z):void 0},w);var qt={blacklist:["_"],whitelist:["datum","event","item"],fieldvar:"datum",globalvar:function(e){return"_["+t.stringValue("$"+e)+"]"},functions:function(e){var t=r.functions(e);Mt.forEach(function(e){t[e]=Lt+e});for(var n in At)t[n]=Wt+n;return t},constants:r.constants,visitors:Ct},Bt=r.codegen(qt),Nt=function(e,n,a){var i,o,l={};try{i=r.parse(e)}catch(n){t.error("Expression parse error: "+t.stringValue(e))}return i.visit(function(e){if("CallExpression"===e.type){var t=e.callee.name,r=qt.visitors[t];r&&r(t,e.arguments,n,l)}}),(o=Bt(i)).globals.forEach(function(e){var t="$"+e;!l.hasOwnProperty(t)&&n.getSignal(e)&&(l[t]=n.signalRef(e))}),{$expr:a?a+"return("+o.code+");":o.code,$fields:o.fields,$params:l}},Ut="view",Tt="scope",It=function(e,t){return e.signal?t.getSignal(e.signal).id:e.scale?t.getScale(e.scale).id:N(e,t)},Xt="var datum=event.item&&event.item.datum;",Ht=function(e,n,r){var a,i=e.events,o=e.update,l=e.encode,u=[],s="";i||t.error("Signal update missing events specification."),t.isString(i)&&(i=f.selector(i)),(i=t.array(i).filter(function(e){return e.signal||e.scale?(u.push(e),0):1})).length&&u.push(i.length>1?{merge:i}:i[0]),null!=l&&(o&&t.error("Signal encode and update are mutually exclusive."),o="encode(item(),"+t.stringValue(l)+")"),s=t.isString(o)?Nt(o,n,Xt):null!=o.expr?Nt(o.expr,n,Xt):null!=o.value?o.value:null!=o.signal?{$expr:"_.value",$params:{value:n.signalRef(o.signal)}}:t.error("Invalid signal update specification."),a={target:r,update:s},e.force&&(a.options={force:!0}),u.forEach(function(e){e={source:It(e,n)},n.addUpdate(t.extend(e,a))})},Yt=function(e,t){var n=t.getSignal(e.name);if(e.update){var r=Nt(e.update,t);n.update=r.$expr,n.params=r.$params}e.on&&e.on.forEach(function(e){Ht(e,t,n.id)})},Gt={$tupleid:1,toString:function(){return":_tupleid_:"}},Jt=Q("key"),Kt="descending",Qt=ie("aggregate"),Zt=ie("axisticks"),en=ie("bound"),tn=ie("collect"),nn=ie("compare"),rn=ie("datajoin"),an=ie("encode"),on=ie("facet"),ln=ie("field"),un=ie("key"),sn=ie("legendentries"),dn=ie("mark"),fn=ie("multiextent"),cn=ie("multivalues"),pn=ie("overlap"),gn=ie("params"),hn=ie("prefacet"),mn=ie("projection"),vn=ie("proxy"),yn=ie("relay"),bn=ie("render"),xn=ie("scale"),kn=ie("sieve"),Sn=ie("sortitems"),Rn=ie("viewlayout"),wn=ie("values"),zn=0,On=["identity","ordinal","band","point","bin-linear","bin-ordinal","linear","pow","sqrt","log","sequential","time","utc","quantize","quantile","threshold"],Pn=t.toSet(On),jn=t.toSet(On.slice(1,6)),Dn=function(e,t){var n={};for(var r in e)"name"!==r&&(n[r]=ze(e[r],t));t.addProjection(e.name,n)},$n="top",En="left",_n="bottom",Vn="value",Fn="guide-label",An="group-title",Mn=["shape","size","fill","stroke","strokeDash","opacity"],Ln={name:1,interactive:1},Wn=t.toSet(["rule"]),Cn=t.toSet(["group","image","rect"]),qn=function(e,t){var n="";return Wn[t]?n:(e.x2&&(e.x?(Cn[t]&&(n+="if(o.x>o.x2)$=o.x,o.x=o.x2,o.x2=$;"),n+="o.width=o.x2-o.x;"):n+="o.x=o.x2-(o.width||0);"),e.xc&&(n+="o.x=o.xc-(o.width||0)/2;"),e.y2&&(e.y?(Cn[t]&&(n+="if(o.y>o.y2)$=o.y,o.y=o.y2,o.y2=$;"),n+="o.height=o.y2-o.y;"):n+="o.y=o.y2-(o.height||0);"),e.yc&&(n+="o.y=o.yc-(o.height||0)/2;"),n)},Bn=function(e,t,n,r){function a(e,a,i,o){return"this."+e+"("+[Hn(null,a,t,n,r),Hn(null,i,t,n,r),Hn(null,o,t,n,r)].join(",")+").toString()"}return e.c?a("hcl",e.h,e.c,e.l):e.h||e.s?a("hsl",e.h,e.s,e.l):e.l||e.a?a("lab",e.l,e.a,e.b):e.r||e.g||e.b?a("rgb",e.r,e.g,e.b):null},Nn=function(e,n,r,a){var i=Nt(e,n);return i.$fields.forEach(function(e){a[e]=1}),t.extend(r,i.$params),i.$expr},Un=function(e,n,r,a){return Oe(t.isObject(e)?e:{datum:e},n,r,a)},Tn=function(e,t,n,r,a){var i,o,l,u=je(e.scale,n,r,a);return null!=e.range?(o=u+".range()",t=0===(i=+e.range)?o+"[0]":"($="+o+","+(1===i?"$[$.length-1]":"$[0]+"+i+"*($[$.length-1]-$[0])")+")"):(void 0!==t&&(t=u+"("+t+")"),e.band&&(l=Pe(e.scale,n))&&(i=(o=u+".bandwidth")+"()"+(1===(i=+e.band)?"":"*"+i),l<0&&(i="("+o+"?"+i+":0)"),t=(t?t+"+":"")+i,e.extra&&(t="(datum.extra?"+u+"(datum.extra.value):"+t+")")),null==t&&(t="0")),t},In=function(e,n,r,a){return"this.gradient("+je(e.gradient,n,r,a)+","+t.stringValue(e.start)+","+t.stringValue(e.stop)+","+t.stringValue(e.count)+")"},Xn=function(e,n,r,a){return t.isObject(e)?"("+Hn(null,e,n,r,a)+")":e},Hn=function(e,n,r,a,i){if(null!=n.gradient)return In(n,r,a,i);var o=n.signal?Nn(n.signal,r,a,i):n.color?Bn(n.color,r,a,i):null!=n.field?Un(n.field,r,a,i):void 0!==n.value?t.stringValue(n.value):void 0;return null!=n.scale&&(o=Tn(n,o,r,a,i)),void 0===o&&(o=null),null!=n.exponent&&(o="Math.pow("+o+","+Xn(n.exponent,r,a,i)+")"),null!=n.mult&&(o+="*"+Xn(n.mult,r,a,i)),null!=n.offset&&(o+="+"+Xn(n.offset,r,a,i)),n.round&&(o="Math.round("+o+")"),o},Yn=function(e,n,r){return e+"["+t.stringValue(n)+"]="+r+";"},Gn=function(e,t,n,r,a){var i="";return t.forEach(function(t){var o=Hn(e,t,n,r,a);i+=t.test?Nn(t.test,n,r,a)+"?"+o+":":o}),Yn("o",e,i)},Jn="mark",Kn="frame",Qn="title",Zn=function(e,t,n,r,a,i,o){return{type:e,name:o?o.name:void 0,role:t,style:o&&o.style||n,key:r,from:a,interactive:!(!o||!o.interactive),encode:_e(i,o,Ln)}},er="group",tr="text",nr=function(e,t,n,r){var a,i,o={value:0},l={};return l.enter=a={opacity:o,x:o,y:o},Ee(a,"width",n.gradientWidth),Ee(a,"height",n.gradientHeight),Ee(a,"stroke",n.gradientStrokeColor),Ee(a,"strokeWidth",n.gradientStrokeWidth),l.exit={opacity:o},l.update=i={x:o,y:o,fill:{gradient:t},opacity:{value:1}},Ee(i,"width",n.gradientWidth),Ee(i,"height",n.gradientHeight),Zn("rect","legend-gradient",null,void 0,void 0,l,r)},rr=function(e,t,n,r){var a,i,o={value:0},l={};return l.enter=a={opacity:o},Ee(a,"fill",t.labelColor),Ee(a,"font",t.labelFont),Ee(a,"fontSize",t.labelFontSize),Ee(a,"baseline",t.gradientLabelBaseline),Ee(a,"limit",t.gradientLabelLimit),l.exit={opacity:o},l.update=i={opacity:{value:1},text:{field:"label"}},a.x=i.x={field:"perc",mult:t.gradientWidth},a.y=i.y={value:t.gradientHeight,offset:t.gradientLabelOffset},a.align=i.align={signal:'datum.perc<=0?"left":datum.perc>=1?"right":"center"'},Zn(tr,"legend-label",Fn,"perc",r,l,n)},ar=function(e,t,n,r){var a,i,o={value:0},l={};return l.enter=a={opacity:o},Ee(a,"align",t.labelAlign),Ee(a,"baseline",t.labelBaseline),Ee(a,"fill",t.labelColor),Ee(a,"font",t.labelFont),Ee(a,"fontSize",t.labelFontSize),Ee(a,"limit",t.labelLimit),l.exit={opacity:o},l.update=i={opacity:{value:1},text:{field:"label"}},a.x=i.x={field:"offset",offset:t.labelOffset},a.y=i.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Zn(tr,"legend-label",Fn,Vn,r,l,n)},ir=function(e,t,n,r){var a,i,o={value:0},l={};return l.enter=a={opacity:o},Ee(a,"shape",t.symbolType),Ee(a,"size",t.symbolSize),Ee(a,"strokeWidth",t.symbolStrokeWidth),e.fill||(Ee(a,"fill",t.symbolFillColor),Ee(a,"stroke",t.symbolStrokeColor)),l.exit={opacity:o},l.update=i={opacity:{value:1}},a.x=i.x={field:"offset",mult:.5},a.y=i.y={field:"size",mult:.5,offset:{field:"total",offset:{field:{group:"entryPadding"},mult:{field:"index"}}}},Mn.forEach(function(t){e[t]&&(i[t]=a[t]={scale:e[t],field:Vn})}),Zn("symbol","legend-symbol",null,Vn,r,l,n)},or=function(e,t,n,r){var a,i={value:0},o=e.title,l={};return l.enter=a={x:{field:{group:"padding"}},y:{field:{group:"padding"}},opacity:i},Ee(a,"align",t.titleAlign),Ee(a,"baseline",t.titleBaseline),Ee(a,"fill",t.titleColor),Ee(a,"font",t.titleFont),Ee(a,"fontSize",t.titleFontSize),Ee(a,"fontWeight",t.titleFontWeight),Ee(a,"limit",t.titleLimit),l.exit={opacity:i},l.update={opacity:{value:1},text:o&&o.signal?{signal:o.signal}:{value:o+""}},Zn(tr,"legend-title","guide-title",null,r,l,n)},lr=function(e,t,n,r,a,i,o){return{type:er,name:n,role:e,style:t,from:r,interactive:a,encode:i,marks:o}},ur=function(e){var t=e.role||"";return t.indexOf("axis")&&t.indexOf("legend")?e.type===er?"scope":t||Jn:t},sr=function(e){return{clip:e.clip||!1,interactive:!1!==e.interactive,marktype:e.type,name:e.name||void 0,role:e.role||ur(e),zindex:+e.zindex||void 0}},dr=function(e,r){var a=n.definition(e.type);a||t.error("Unrecognized transform type: "+t.stringValue(e.type));var i=G(a.type.toLowerCase(),null,Me(a,e,r));return e.signal&&r.addSignal(e.signal,r.proxy(i)),i.metadata=a.metadata||{},i},fr=function(e,n,r){var a,i,o,l,u;return e?(a=e.facet)&&(n||t.error("Only group marks can be faceted."),null!=a.field?l=u=K(r.getData(a.data).output):(e.data?u=K(r.getData(e.data).aggregate):((o=dr(t.extend({type:"aggregate",groupby:t.array(a.groupby)},a.aggregate),r)).params.key=r.keyRef(a.groupby),o.params.pulse=K(r.getData(a.data).output),l=u=K(r.add(o))),i=r.keyRef(a.groupby,!0))):l=K(r.add(tn(null,[{}]))),l||(l=e.$ref?e:K(r.getData(e.data).output)),{key:i,pulse:l,parent:u}};Ye.fromEntries=function(e,t){var n=t.length,r=1,a=t[0],i=t[n-1],o=t[n-2],l=null;for(e.add(t[0]);r<n;++r)t[r].params.pulse=K(t[r-1]),e.add(t[r]),"aggregate"===t[r].type&&(l=t[r]);return new Ye(e,a,o,i,l)};var cr=Ye.prototype;cr.countsRef=function(e,t,n){var r,a,i,o=this,l=o.counts||(o.counts={}),u=Ge(t);return null!=u&&(e=o.scope,r=l[u]),r?n&&n.field&&Je(e,r.agg.params,n):(i={groupby:e.fieldRef(t,"key"),pulse:K(o.output)},n&&n.field&&Je(e,i,n),r={agg:a=e.add(Qt(i)),ref:K(r=e.add(tn({pulse:K(a)})))},null!=u&&(l[u]=r)),r.ref},cr.tuplesRef=function(){return K(this.values)},cr.extentRef=function(e,t){return Ke(e,this,"extent","extent",t,!1)},cr.domainRef=function(e,t){return Ke(e,this,"domain","values",t,!1)},cr.valuesRef=function(e,t,n){return Ke(e,this,"vals","values",t,n||!0)},cr.lookupRef=function(e,t){return Ke(e,this,"lookup","tupleindex",t,!1)},cr.indataRef=function(e,t){return Ke(e,this,"indata","tupleindex",t,!0,!0)};var pr=function(e,n,r){var a,i,o,l,u=e.from.facet,s=u.name,d=K(n.getData(u.data).output);u.name||t.error("Facet must have a name: "+t.stringValue(u)),u.data||t.error("Facet must reference a data set: "+t.stringValue(u)),u.field?l=n.add(hn({field:n.fieldRef(u.field),pulse:d})):u.groupby?l=n.add(on({key:n.keyRef(u.groupby),group:K(n.proxy(r.parent)),pulse:d})):t.error("Facet must specify groupby or field: "+t.stringValue(u)),i=(a=n.fork()).add(tn()),o=a.add(kn({pulse:K(i)})),a.addData(s,new Ye(a,i,i,o)),a.addSignal("parent",null),l.params.subflow={$subflow:Or(e,a).toRuntime()}},gr=function(e,t,n){var r=t.add(hn({pulse:n.pulse})),a=t.fork();a.add(kn()),a.addSignal("parent",null),r.params.subflow={$subflow:Or(e,a).toRuntime()}},hr=function(e,t,n){var r,a,i=e.remove,o=e.insert,l=e.toggle,u=e.modify,s=e.values,d=t.add(J());r="if("+e.trigger+',modify("'+n+'",'+[o,i,l,u,s].map(function(e){return null==e?"null":e}).join(",")+"),0)",a=Nt(r,t),d.update=a.$expr,d.params=a.$params},mr=function(e,n){var r,a,i,o,l,u,s,d,f,c,p,g,h,m=ur(e),v=e.type===er,y=e.from&&e.from.facet,b=e.layout||"scope"===m||m===Kn,x=m===Jn||b||y,k=e.overlap;i=fr(e.from,v,n),f=K(a=n.add(rn({key:i.key||(e.key?Q(e.key):void 0),pulse:i.pulse,clean:!v}))),a=o=n.add(tn({pulse:f})),c=K(a=n.add(dn({markdef:sr(e),context:{$context:!0},groups:n.lookup(),parent:n.signals.parent?n.signalRef("parent"):null,index:n.markpath(),pulse:K(a)}))),(a=n.add(an(Ve(e.encode,e.type,m,e.style,n,{pulse:c})))).params.parent=n.encode(),e.transform&&e.transform.forEach(function(e){var r=dr(e,n);(r.metadata.generates||r.metadata.changes)&&t.error("Mark transforms should not generate new data."),r.params.pulse=K(a),n.add(a=r)}),e.sort&&(a=n.add(Sn({sort:n.compareRef(e.sort),pulse:K(a)}))),p=K(a),(y||b)&&(g=K(b=n.add(Rn({layout:n.objectProperty(e.layout),legendMargin:n.config.legendMargin,mark:c,pulse:p})))),h=K(l=n.add(en({mark:c,pulse:g||p}))),v&&(x&&((r=n.operators).pop(),b&&r.pop()),n.pushState(p,g||h,f),y?pr(e,n,i):x?gr(e,n,i):Or(e,n),n.popState(),x&&(b&&r.push(b),r.push(l))),k&&(a={method:!0===k.method?"parity":k.method,pulse:h},k.order&&(a.sort=n.compareRef({field:k.order})),k.bound&&(a.boundScale=n.scaleRef(k.bound.scale),a.boundOrient=k.bound.orient,a.boundTolerance=k.bound.tolerance),h=K(n.add(pn(a)))),u=n.add(bn({pulse:h})),s=n.add(kn({pulse:K(u)},void 0,n.parent())),null!=e.name&&(d=e.name,n.addData(d,new Ye(n,o,u,s)),e.on&&e.on.forEach(function(e){(e.insert||e.remove||e.toggle)&&t.error("Marks only support modify triggers."),hr(e,n,d)}))},vr=function(e,n){var r,a,i,o,l,u,s,d,f=e.type||"symbol",c=n.config.legend,p=e.encode||{},g=p.legend||{},h=g.name||void 0,m=!!g.interactive,v=g.style,y=e.size||e.shape||e.fill||e.stroke||e.strokeDash||e.opacity;return y||t.error("Missing valid scale for legend."),r={orient:ae(e.orient,c.orient),title:null!=e.title},a=K(n.add(tn(null,[r]))),g=_e({enter:Ze(c),update:{offset:$e(ae(e.offset,c.offset)),padding:$e(ae(e.padding,c.padding)),titlePadding:$e(ae(e.titlePadding,c.titlePadding))}},g,Ln),u={update:{x:{field:{group:"padding"}},y:{field:{group:"padding"}},entryPadding:$e(ae(e.entryPadding,c.entryPadding))}},"gradient"===f?(i=K(n.add(sn({type:"gradient",scale:n.scaleRef(y),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[nr(0,y,c,p.gradient),rr(0,c,p.labels,i)]):(i=K(n.add(sn(s={scale:n.scaleRef(y),count:n.objectProperty(e.tickCount),values:n.objectProperty(e.values),formatSpecifier:n.property(e.format)}))),d=[ir(e,c,p.symbols,i),ar(0,c,p.labels,i)],s.size=Qe(e,n,d)),d=[lr("legend-entry",null,null,a,m,u,d)],r.title&&(l=or(e,c,p.title,a),u.update.y.offset={field:{group:"titlePadding"},offset:et(n,l.encode,"fontSize","guide-title")},d.push(l)),o=lr("legend",v,h,a,m,g,d),e.zindex&&(o.zindex=e.zindex),mr(o,n)},yr=function(e,n){e=t.isString(e)?{text:e}:e;var r,a,i,o=n.config.title,l=t.extend({},e.encode);return r={orient:null!=e.orient?e.orient:o.orient},a=K(n.add(tn(null,[r]))),l.name=e.name,l.interactive=e.interactive,i=tt(e,o,l,a),e.zindex&&(i.zindex=e.zindex),mr(i,n)},br=function(e,n){var r=n.config,a=e.orient,i=a===$n||a===_n?r.axisX:r.axisY,o=r["axis"+a[0].toUpperCase()+a.slice(1)],l="band"===n.scaleType(e.scale)&&r.axisBand;return i||o||l?t.extend({},r.axis,i,o,l):r.axis},xr=function(e,t,n,r){var a,i,o,l,u,s=e.orient,d={value:0},f={};return f.enter=a={opacity:d},Ee(a,"stroke",t.domainColor),Ee(a,"strokeWidth",t.domainWidth),f.exit={opacity:d},f.update=i={opacity:{value:1}},s===$n||s===_n?(o="x",u="y"):(o="y",u="x"),l=o+"2",a[u]=d,i[o]=a[o]=it(e,0),i[l]=a[l]=it(e,1),Zn("rule","axis-domain",null,null,r,f,n)},kr=function(e,t,n,r){var a,i,o,l,u,s,d,f,c=e.orient,p=e.gridScale,g=c===En||c===$n?1:-1,h=g*e.offset||0,m={value:0},v={};return v.enter=a={opacity:m},Ee(a,"stroke",t.gridColor),Ee(a,"strokeWidth",t.gridWidth),Ee(a,"strokeDash",t.gridDash),v.exit=i={opacity:m},v.update=o={},Ee(o,"opacity",t.gridOpacity),l={scale:e.scale,field:Vn,band:t.bandPosition,round:t.tickRound,extra:t.tickExtra,offset:t.tickOffset},c===$n||c===_n?(u="x",s="y",f="height"):(u="y",s="x",f="width"),d=s+"2",o[u]=a[u]=i[u]=l,p?(a[s]={scale:p,range:0,mult:g,offset:h},o[d]=a[d]={scale:p,range:1,mult:g,offset:h}):(a[s]={value:h},o[d]=a[d]={signal:f,mult:g,offset:h}),Zn("rule","axis-grid",null,Vn,r,v,n)},Sr=function(e,t,n,r,a){var i,o,l,u,s,d=e.orient,f=d===En||d===$n?-1:1,c={value:0},p={};return p.enter=i={opacity:c},Ee(i,"stroke",t.tickColor),Ee(i,"strokeWidth",t.tickWidth),p.exit=o={opacity:c},p.update=l={opacity:{value:1}},u=$e(a),u.mult=f,s={scale:e.scale,field:Vn,band:t.bandPosition,round:t.tickRound,extra:t.tickExtra,offset:t.tickOffset},d===$n||d===_n?(l.y=i.y=c,l.y2=i.y2=u,l.x=i.x=o.x=s):(l.x=i.x=c,l.x2=i.x2=u,l.y=i.y=o.y=s),Zn("rule","axis-tick",null,Vn,r,p,n)},Rr=function(e,t,n,r,a){var i,o,l,u,s,d=e.orient,f=d===En||d===$n?-1:1,c=e.scale,p=ae(e.labelPadding,t.labelPadding),g=ae(e.labelBound,t.labelBound),h=ae(e.labelFlush,t.labelFlush),m=null!=h&&!1!==h&&(h=+h)===h,v=+ae(e.labelFlushOffset,t.labelFlushOffset),y=ae(e.labelOverlap,t.labelOverlap),b={value:0},x={};return x.enter=i={opacity:b},Ee(i,"angle",t.labelAngle),Ee(i,"fill",t.labelColor),Ee(i,"font",t.labelFont),Ee(i,"fontSize",t.labelFontSize),Ee(i,"limit",t.labelLimit),x.exit=o={opacity:b},x.update=l={opacity:{value:1},text:{field:"label"}},u=$e(a),u.mult=f,u.offset=$e(p),u.offset.mult=f,s={scale:c,field:Vn,band:.5,offset:t.tickOffset},d===$n||d===_n?(l.y=i.y=u,l.x=i.x=o.x=s,Ee(l,"align",m?ot(c,h,'"left"','"right"','"center"'):"center"),m&&v&&Ee(l,"dx",ot(c,h,-v,v,0)),Ee(l,"baseline",d===$n?"bottom":"top")):(l.x=i.x=u,l.y=i.y=o.y=s,Ee(l,"align","right"===d?"left":"right"),Ee(l,"baseline",m?ot(c,h,'"bottom"','"top"','"middle"'):"middle"),m&&v&&Ee(l,"dy",ot(c,h,v,-v,0))),e=Zn(tr,"axis-label",Fn,Vn,r,x,n),(y||g)&&(e.overlap={method:y,order:"datum.index",bound:g?{scale:c,orient:d,tolerance:+g}:null}),e},wr=function(e,t,n,r){var a,i,o,l=e.orient,u=e.title,s=l===En||l===$n?-1:1,d=l===$n||l===_n,f={};return f.enter=a={opacity:{value:0}},Ee(a,"align",t.titleAlign),Ee(a,"fill",t.titleColor),Ee(a,"font",t.titleFont),Ee(a,"fontSize",t.titleFontSize),Ee(a,"fontWeight",t.titleFontWeight),Ee(a,"limit",t.titleLimit),f.exit={opacity:{value:0}},f.update=i={opacity:{value:1},text:u&&u.signal?{signal:u.signal}:{value:u+""}},o={scale:e.scale,range:.5},d?(i.x=o,i.angle={value:0},i.baseline={value:l===$n?"bottom":"top"}):(i.y=o,i.angle={value:90*s},i.baseline={value:"bottom"}),Ee(i,"angle",t.titleAngle),Ee(i,"baseline",t.titleBaseline),!Ee(i,"x",t.titleX)&&d&&!Ae("x",n)&&(f.enter.auto={value:!0}),!Ee(i,"y",t.titleY)&&!d&&!Ae("y",n)&&(f.enter.auto={value:!0}),Zn(tr,"axis-title","guide-title",null,r,f,n)},zr=function(e,t){var n,r,a,i,o,l,u=br(e,t),s=e.encode||{},d=s.axis||{},f=d.name||void 0,c=!!d.interactive,p=d.style;return n={orient:e.orient,ticks:!!ae(e.ticks,u.ticks),labels:!!ae(e.labels,u.labels),grid:!!ae(e.grid,u.grid),domain:!!ae(e.domain,u.domain),title:!!ae(e.title,!1)},r=K(t.add(tn({},[n]))),d=_e({update:{range:{signal:'abs(span(range("'+e.scale+'")))'},offset:$e(ae(e.offset,0)),position:$e(ae(e.position,0)),titlePadding:$e(ae(e.titlePadding,u.titlePadding)),minExtent:$e(ae(e.minExtent,u.minExtent)),maxExtent:$e(ae(e.maxExtent,u.maxExtent))}},s.axis,Ln),a=K(t.add(Zt({scale:t.scaleRef(e.scale),extra:u.tickExtra,count:t.objectProperty(e.tickCount),values:t.objectProperty(e.values),formatSpecifier:t.property(e.format)}))),l=[],n.grid&&l.push(kr(e,u,s.grid,a)),n.ticks&&(i=ae(e.tickSize,u.tickSize),l.push(Sr(e,u,s.ticks,a,i))),n.labels&&(i=n.ticks?i:0,l.push(Rr(e,u,s.labels,a,i))),n.domain&&l.push(xr(e,u,s.domain,r)),n.title&&l.push(wr(e,u,s.title,r)),o=lr("axis",p,f,r,c,d,l),e.zindex&&(o.zindex=e.zindex),mr(o,t)},Or=function(e,n,r){var a=t.array(e.signals),i=t.array(e.scales);return r||a.forEach(function(e){vt(e,n)}),t.array(e.projections).forEach(function(e){Dn(e,n)}),i.forEach(function(e){ue(e,n)}),t.array(e.data).forEach(function(e){nt(e,n)}),i.forEach(function(e){se(e,n)}),a.forEach(function(e){Yt(e,n)}),t.array(e.axes).forEach(function(e){zr(e,n)}),t.array(e.marks).forEach(function(e){mr(e,n)}),t.array(e.legends).forEach(function(e){vr(e,n)}),e.title&&yr(e.title,n),n.parseLambdas(),n},Pr=t.toSet(["width","height","padding","autosize"]),jr=ut.prototype=st.prototype;jr.fork=function(){return new st(this)},jr.toRuntime=function(){return this.finish(),{background:this.background,operators:this.operators,streams:this.streams,updates:this.updates,bindings:this.bindings,eventConfig:this.eventConfig}},jr.id=function(){return(this._subid?this._subid+":":0)+this._id++},jr.add=function(e){return this.operators.push(e),e.id=this.id(),e.refs&&(e.refs.forEach(function(t){t.$ref=e.id}),e.refs=null),e},jr.proxy=function(e){var t=e instanceof Y?K(e):e;return this.add(vn({value:t}))},jr.addStream=function(e){return this.streams.push(e),e.id=this.id(),e},jr.addUpdate=function(e){return this.updates.push(e),e},jr.finish=function(){function e(e,t,n){var r;e&&((r=e.data||(e.data={}))[t]||(r[t]=[])).push(n)}var t,n;this.root&&(this.root.root=!0);for(t in this.signals)this.signals[t].signal=t;for(t in this.scales)this.scales[t].scale=t;for(t in this.data){e((n=this.data[t]).input,t,"input"),e(n.output,t,"output"),e(n.values,t,"values");for(var r in n.index)e(n.index[r],t,"index:"+r)}return this},jr.pushState=function(e,t,n){this._encode.push(K(this.add(kn({pulse:e})))),this._parent.push(t),this._lookup.push(n?K(this.proxy(n)):null),this._markpath.push(-1)},jr.popState=function(){this._encode.pop(),this._parent.pop(),this._lookup.pop(),this._markpath.pop()},jr.parent=function(){return t.peek(this._parent)},jr.encode=function(){return t.peek(this._encode)},jr.lookup=function(){return t.peek(this._lookup)},jr.markpath=function(){var e=this._markpath;return++e[e.length-1]},jr.fieldRef=function(e,n){if(t.isString(e))return Q(e,n);e.signal||t.error("Unsupported field reference: "+t.stringValue(e));var r,a=e.signal,i=this.field[a];return i||(r={name:this.signalRef(a)},n&&(r.as=n),this.field[a]=i=K(this.add(ln(r)))),i},jr.compareRef=function(e){function n(e){return re(e)?(a=!0,K(r[e.signal])):e}var r=this.signals,a=!1,i=t.array(e.field).map(n),o=t.array(e.order).map(n);return a?K(this.add(nn({fields:i,orders:o}))):Z(i,o)},jr.keyRef=function(e,n){var r=this.signals,a=!1;return e=t.array(e).map(function(e){return re(e)?(a=!0,K(r[e.signal])):e}),a?K(this.add(un({fields:e,flat:n}))):ee(e,n)},jr.sortRef=function(e){if(!e)return e;var t=[ne(e.op,e.field),Gt],n=e.order||"ascending";return n.signal?K(this.add(nn({fields:t,orders:[n=this.signalRef(n.signal),n]}))):Z(t,[n,n])},jr.event=function(e,t){var n=e+":"+t;if(!this.events[n]){var r=this.id();this.streams.push({id:r,source:e,type:t}),this.events[n]=r}return this.events[n]},jr.addSignal=function(e,n){this.signals.hasOwnProperty(e)&&t.error("Duplicate signal name: "+t.stringValue(e));var r=n instanceof Y?n:this.add(J(n));return this.signals[e]=r},jr.getSignal=function(e){return this.signals[e]||t.error("Unrecognized signal name: "+t.stringValue(e)),this.signals[e]},jr.signalRef=function(e){return this.signals[e]?K(this.signals[e]):(this.lambdas.hasOwnProperty(e)||(this.lambdas[e]=this.add(J(null))),K(this.lambdas[e]))},jr.parseLambdas=function(){for(var e=Object.keys(this.lambdas),t=0,n=e.length;t<n;++t){var r=e[t],a=Nt(r,this),i=this.lambdas[r];i.params=a.$params,i.update=a.$expr}},jr.property=function(e){return e&&e.signal?this.signalRef(e.signal):e},jr.objectProperty=function(e){return e&&t.isObject(e)?this.signalRef(e.signal||dt(e)):e},jr.addBinding=function(e,n){this.bindings||t.error("Nested signals do not support binding: "+t.stringValue(e)),this.bindings.push(t.extend({signal:e},n))},jr.addScaleProj=function(e,n){this.scales.hasOwnProperty(e)&&t.error("Duplicate scale or projection name: "+t.stringValue(e)),this.scales[e]=this.add(n)},jr.addScale=function(e,t){this.addScaleProj(e,xn(t))},jr.addProjection=function(e,t){this.addScaleProj(e,mn(t))},jr.getScale=function(e){return this.scales[e]||t.error("Unrecognized scale name: "+t.stringValue(e)),this.scales[e]},jr.projectionRef=jr.scaleRef=function(e){return K(this.getScale(e))},jr.projectionType=jr.scaleType=function(e){return this.getScale(e).params.type},jr.addData=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.data[e]=n},jr.getData=function(e){return this.data[e]||t.error("Undefined data set name: "+t.stringValue(e)),this.data[e]},jr.addDataPipeline=function(e,n){return this.data.hasOwnProperty(e)&&t.error("Duplicate data set name: "+t.stringValue(e)),this.addData(e,Ye.fromEntries(this,n))};var Dr=function(e){var n=pt();return(e||[]).forEach(function(e){var r,a;if(e)for(r in e)if("style"===r){a=n.style||(n.style={});for(r in e.style)a[r]=t.extend(a[r]||{},e.style[r])}else n[r]=t.isObject(e[r])?t.extend(n[r]||{},e[r]):e[r]}),n},$r="sans-serif",Er=30,_r=2,Vr="#4c78a8",Fr="#000",Ar="#888",Mr="#ddd";e.parse=function(e,n){return t.isObject(e)||t.error("Input Vega specification must be an object."),lt(e,new ut(Dr([n,e.config]))).toRuntime()},e.signal=vt,e.signalUpdates=Yt,e.stream=It,e.codeGenerator=Bt,e.functionContext=At,e.expressionFunction=q,e.MarkRole=Jn,e.FrameRole=Kn,e.ScopeRole="scope",e.AxisRole="axis",e.AxisDomainRole="axis-domain",e.AxisGridRole="axis-grid",e.AxisLabelRole="axis-label",e.AxisTickRole="axis-tick",e.AxisTitleRole="axis-title",e.LegendRole="legend",e.LegendEntryRole="legend-entry",e.LegendLabelRole="legend-label",e.LegendSymbolRole="legend-symbol",e.LegendTitleRole="legend-title",e.Scope=ut,e.DataScope=Ye,e.formatLocale=l.formatDefaultLocale,e.timeFormatLocale=u.timeFormatDefaultLocale,Object.defineProperty(e,"__esModule",{value:!0})});