"use strict";
var __assign = (this && this.__assign) || Object.assign || function(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
        s = arguments[i];
        for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p))
            t[p] = s[p];
    }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
var chai_1 = require("chai");
var util_1 = require("./util");
var hits = {
    zoom: [9, 23],
    bins: [8, 2]
};
function zoom(key, idx, zoom, parent, targetBrush) {
    var delta = zoom === 'out' ? 200 : -200;
    return "return zoom(" + hits[key][idx] + ", " + delta + ", " + parent + ", " + targetBrush + ")";
}
var cmp = function (a, b) { return a - b; };
[util_1.bound, util_1.unbound].forEach(function (bind) {
    describe("Zoom " + bind + " interval selections at runtime", function () {
        var type = 'interval';
        var embed = util_1.embedFn(browser);
        var testRender = util_1.testRenderFn(browser, "interval/zoom/" + bind);
        var binding = bind === util_1.bound ? { bind: 'scales' } : {};
        var assertExtent = {
            in: ['isAtLeast', 'isAtMost'], out: ['isAtMost', 'isAtLeast']
        };
        function setup(brushKey, idx, encodings, parent) {
            var inOut = idx % 2 ? 'out' : 'in';
            var xold;
            var yold;
            if (bind === util_1.unbound) {
                var drag = browser.execute(util_1.brush(brushKey, idx, parent)).value[0];
                xold = drag.intervals[0].extent.sort(cmp);
                yold = encodings.indexOf('y') >= 0 ? drag.intervals[encodings.indexOf('x') + 1].extent.sort(cmp) : null;
            }
            else {
                xold = JSON.parse(browser.execute('return JSON.stringify(view._runtime.scales.x.value.domain())').value);
                yold = browser.execute('return view._runtime.scales.y.value.domain()').value;
            }
            return { inOut: inOut, xold: xold, yold: yold };
        }
        it('should zoom in and out', function () {
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding)));
                var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                testRender(inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                var ynew = zoomed.intervals[1].extent.sort(cmp);
                testRender(inOut + "-1");
                chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
            }
        });
        it('should work with binned domains', function () {
            for (var i = 0; i < hits.bins.length; i++) {
                var encodings = ['y'];
                embed(util_1.spec('unit', 1, __assign({ type: type }, binding, { encodings: encodings }), {
                    x: { aggregate: 'count', field: '*', type: 'quantitative' },
                    y: { bin: true },
                    color: { value: 'steelblue', field: null, type: null }
                }));
                var _a = setup('bins', i, encodings), inOut = _a.inOut, yold = _a.yold;
                testRender("bins_" + inOut + "-0");
                var zoomed = browser.execute(zoom('bins', i, inOut, null, bind === util_1.unbound)).value[0];
                var ynew = zoomed.intervals[0].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                testRender("bins_" + inOut + "-1");
            }
        });
        it('should work with temporal domains', function () {
            var values = util_1.tuples.map(function (d) { return (__assign({}, d, { a: new Date(2017, d.a) })); });
            var encodings = ['x'];
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding, { encodings: encodings }), { values: values, x: { type: 'temporal' } }));
                var _a = setup('drag', i, encodings), inOut = _a.inOut, xold = _a.xold;
                testRender("temporal_" + inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](+xnew[0], +(new Date(xold[0])));
                chai_1.assert[assertExtent[inOut][1]](+xnew[1], +(new Date(xold[1])));
                testRender("temporal_" + inOut + "-1");
            }
        });
        it('should work with log/pow scales', function () {
            for (var i = 0; i < hits.zoom.length; i++) {
                embed(util_1.spec('unit', i, __assign({ type: type }, binding), {
                    x: { scale: { type: 'pow', exponent: 1.5 } },
                    y: { scale: { type: 'log' } }
                }));
                var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                testRender("logpow_" + inOut + "-0");
                var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                var xnew = zoomed.intervals[0].extent.sort(cmp);
                var ynew = zoomed.intervals[1].extent.sort(cmp);
                chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                testRender("logpow_" + inOut + "-1");
            }
        });
        if (bind === util_1.unbound) {
            it('should work with ordinal/nominal domains', function () {
                for (var i = 0; i < hits.zoom.length; i++) {
                    embed(util_1.spec('unit', i, __assign({ type: type }, binding), {
                        x: { type: 'ordinal' }, y: { type: 'nominal' }
                    }));
                    var _a = setup('drag', i, ['x', 'y']), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                    testRender("ord_" + inOut + "-0");
                    var zoomed = browser.execute(zoom('zoom', i, inOut, null, bind === util_1.unbound)).value[0];
                    var xnew = zoomed.intervals[0].extent.sort(cmp);
                    var ynew = zoomed.intervals[1].extent.sort(cmp);
                    if (inOut === 'in') {
                        chai_1.assert.isAtMost(xnew.length, xold.length);
                        chai_1.assert.isAtMost(ynew.length, yold.length);
                    }
                    else {
                        chai_1.assert.isAtLeast(xnew.length, xold.length);
                        chai_1.assert.isAtLeast(ynew.length, yold.length);
                    }
                    testRender("ord_" + inOut + "-1");
                }
            });
        }
        else {
            util_1.compositeTypes.forEach(function (specType) {
                it("should work with shared scales in " + specType + " views", function () {
                    for (var i = 0; i < hits.bins.length; i++) {
                        embed(util_1.spec(specType, 0, __assign({ type: type }, binding), { resolve: { scale: { x: 'shared', y: 'shared' } } }));
                        var parent_1 = util_1.parentSelector(specType, i);
                        var _a = setup(specType, i, ['x', 'y'], parent_1), inOut = _a.inOut, xold = _a.xold, yold = _a.yold;
                        var zoomed = browser.execute(zoom('bins', i, inOut, null, bind === util_1.unbound)).value[0];
                        var xnew = zoomed.intervals[0].extent.sort(cmp);
                        var ynew = zoomed.intervals[1].extent.sort(cmp);
                        chai_1.assert[assertExtent[inOut][0]](xnew[0], xold[0]);
                        chai_1.assert[assertExtent[inOut][1]](xnew[1], xold[1]);
                        chai_1.assert[assertExtent[inOut][0]](ynew[0], yold[0]);
                        chai_1.assert[assertExtent[inOut][1]](ynew[1], yold[1]);
                        testRender(specType + "_" + inOut);
                    }
                });
            });
        }
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiem9vbS50ZXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdGVzdC1ydW50aW1lL3pvb20udGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7O0FBQUEsNkJBQTRCO0FBQzVCLCtCQVVnQjtBQUVoQixJQUFNLElBQUksR0FBRztJQUNYLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUM7SUFDYixJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ2IsQ0FBQztBQUlGLGNBQWMsR0FBVyxFQUFFLEdBQVcsRUFBRSxJQUFXLEVBQUUsTUFBZSxFQUFFLFdBQXFCO0lBQ3pGLElBQU0sS0FBSyxHQUFHLElBQUksS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUM7SUFDMUMsTUFBTSxDQUFDLGlCQUFlLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBSyxLQUFLLFVBQUssTUFBTSxVQUFLLFdBQVcsTUFBRyxDQUFDO0FBQy9FLENBQUM7QUFFRCxJQUFNLEdBQUcsR0FBRyxVQUFDLENBQVMsRUFBRSxDQUFTLElBQUssT0FBQSxDQUFDLEdBQUcsQ0FBQyxFQUFMLENBQUssQ0FBQztBQUU1QyxDQUFDLFlBQUssRUFBRSxjQUFPLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBUyxJQUFJO0lBQ3BDLFFBQVEsQ0FBQyxVQUFRLElBQUksb0NBQWlDLEVBQUU7UUFDdEQsSUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDO1FBQ3hCLElBQU0sS0FBSyxHQUFHLGNBQU8sQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQixJQUFNLFVBQVUsR0FBRyxtQkFBWSxDQUFDLE9BQU8sRUFBRSxtQkFBaUIsSUFBTSxDQUFDLENBQUM7UUFDbEUsSUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFLLFlBQUssQ0FBQyxDQUFDLENBQUMsRUFBQyxJQUFJLEVBQUUsUUFB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QUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDakQsYUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDakQsYUFBTSxDQUFDLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQzt3QkFDakQsVUFBVSxDQUFJLFFBQVEsU0FBSSxLQUFPLENBQUMsQ0FBQztvQkFDckMsQ0FBQztnQkFDSCxDQUFDLENBQUMsQ0FBQztZQUNMLENBQUMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztJQUNILENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2Fzc2VydH0gZnJvbSAnY2hhaSc7XG5pbXBvcnQge1xuICBib3VuZCxcbiAgYnJ1c2gsXG4gIGNvbXBvc2l0ZVR5cGVzLFxuICBlbWJlZEZuLFxuICBwYXJlbnRTZWxlY3RvcixcbiAgc3BlYyxcbiAgdGVzdFJlbmRlckZuLFxuICB0dXBsZXMsXG4gIHVuYm91bmQsXG59IGZyb20gJy4vdXRpbCc7XG5cbmNvbnN0IGhpdHMgPSB7XG4gIHpvb206IFs5LCAyM10sXG4gIGJpbnM6IFs4LCAyXVxufTtcblxudHlwZSBJbk91dCA9ICdpbicgfCAnb3V0JztcblxuZnVuY3Rpb24gem9vbShrZXk6IHN0cmluZywgaWR4OiBudW1iZXIsIHpvb206IEluT3V0LCBwYXJlbnQ/OiBzdHJpbmcsIHRhcmdldEJydXNoPzogYm9vbGVhbikge1xuICBjb25zdCBkZWx0YSA9IHpvb20gPT09ICdvdXQnID8gMjAwIDogLTIwMDtcbiAgcmV0dXJuIGByZXR1cm4gem9vbSgke2hpdHNba2V5XVtpZHhdfSwgJHtkZWx0YX0sICR7cGFyZW50fSwgJHt0YXJnZXRCcnVzaH0pYDtcbn1cblxuY29uc3QgY21wID0gKGE6IG51bWJlciwgYjogbnVtYmVyKSA9PiBhIC0gYjtcblxuW2JvdW5kLCB1bmJvdW5kXS5mb3JFYWNoKGZ1bmN0aW9uKGJpbmQpIHtcbiAgZGVzY3JpYmUoYFpvb20gJHtiaW5kfSBpbnRlcnZhbCBzZWxlY3Rpb25zIGF0IHJ1bnRpbWVgLCBmdW5jdGlvbigpIHtcbiAgICBjb25zdCB0eXBlID0gJ2ludGVydmFsJztcbiAgICBjb25zdCBlbWJlZCA9IGVtYmVkRm4oYnJvd3Nlcik7XG4gICAgY29uc3QgdGVzdFJlbmRlciA9IHRlc3RSZW5kZXJGbihicm93c2VyLCBgaW50ZXJ2YWwvem9vbS8ke2JpbmR9YCk7XG4gICAgY29uc3QgYmluZGluZyA9IGJpbmQgPT09IGJvdW5kID8ge2JpbmQ6ICdzY2FsZXMnfSA6IHt9O1xuXG4gICAgY29uc3QgYXNzZXJ0RXh0ZW50ID0ge1xuICAgICAgaW46IFsnaXNBdExlYXN0JywgJ2lzQXRNb3N0J10sIG91dDogWydpc0F0TW9zdCcsICdpc0F0TGVhc3QnXVxuICAgIH07XG5cbiAgICBmdW5jdGlvbiBzZXR1cChicnVzaEtleTogc3RyaW5nLCBpZHg6IG51bWJlciwgZW5jb2RpbmdzOiBzdHJpbmdbXSwgcGFyZW50Pzogc3RyaW5nKSB7XG4gICAgICBjb25zdCBpbk91dDogSW5PdXQgPSBpZHggJSAyID8gJ291dCcgOiAnaW4nO1xuICAgICAgbGV0IHhvbGQ6IG51bWJlcltdO1xuICAgICAgbGV0IHlvbGQ6IG51bWJlcltdO1xuXG4gICAgICBpZiAoYmluZCA9PT0gdW5ib3VuZCkge1xuICAgICAgICBjb25zdCBkcmFnID0gYnJvd3Nlci5leGVjdXRlKGJydXNoKGJydXNoS2V5LCBpZHgsIHBhcmVudCkpLnZhbHVlWzBdO1xuICAgICAgICB4b2xkID0gZHJhZy5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgeW9sZCA9IGVuY29kaW5ncy5pbmRleE9mKCd5JykgPj0gMCA/IGRyYWcuaW50ZXJ2YWxzW2VuY29kaW5ncy5pbmRleE9mKCd4JykgKyAxXS5leHRlbnQuc29ydChjbXApIDogbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHhvbGQgPSBKU09OLnBhcnNlKGJyb3dzZXIuZXhlY3V0ZSgncmV0dXJuIEpTT04uc3RyaW5naWZ5KHZpZXcuX3J1bnRpbWUuc2NhbGVzLngudmFsdWUuZG9tYWluKCkpJykudmFsdWUpO1xuICAgICAgICB5b2xkID0gYnJvd3Nlci5leGVjdXRlKCdyZXR1cm4gdmlldy5fcnVudGltZS5zY2FsZXMueS52YWx1ZS5kb21haW4oKScpLnZhbHVlO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge2luT3V0LCB4b2xkLCB5b2xkfTtcbiAgICB9XG5cbiAgICBpdCgnc2hvdWxkIHpvb20gaW4gYW5kIG91dCcsIGZ1bmN0aW9uKCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXRzLnpvb20ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgZW1iZWQoc3BlYygndW5pdCcsIGksIHt0eXBlLCAuLi5iaW5kaW5nfSkpO1xuICAgICAgICBjb25zdCB7aW5PdXQsIHhvbGQsIHlvbGR9ID0gc2V0dXAoJ2RyYWcnLCBpLCBbJ3gnLCAneSddKTtcbiAgICAgICAgdGVzdFJlbmRlcihgJHtpbk91dH0tMGApO1xuXG4gICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCd6b29tJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgY29uc3QgeG5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgY29uc3QgeW5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMV0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgdGVzdFJlbmRlcihgJHtpbk91dH0tMWApO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVswXV0oeG5ld1swXSwgeG9sZFswXSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzFdXSh4bmV3WzFdLCB4b2xkWzFdKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHluZXdbMF0sIHlvbGRbMF0pO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeW5ld1sxXSwgeW9sZFsxXSk7XG5cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgd29yayB3aXRoIGJpbm5lZCBkb21haW5zJywgZnVuY3Rpb24oKSB7XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGhpdHMuYmlucy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zdCBlbmNvZGluZ3MgPSBbJ3knXTtcbiAgICAgICAgZW1iZWQoc3BlYygndW5pdCcsIDEsIHt0eXBlLCAuLi5iaW5kaW5nLCBlbmNvZGluZ3N9LCB7XG4gICAgICAgICAgeDoge2FnZ3JlZ2F0ZTogJ2NvdW50JywgZmllbGQ6ICcqJywgdHlwZTogJ3F1YW50aXRhdGl2ZSd9LFxuICAgICAgICAgIHk6IHtiaW46IHRydWV9LFxuICAgICAgICAgIGNvbG9yOiB7dmFsdWU6ICdzdGVlbGJsdWUnLCBmaWVsZDogbnVsbCwgdHlwZTogbnVsbH1cbiAgICAgICAgfSkpO1xuXG4gICAgICAgIGNvbnN0IHtpbk91dCwgeW9sZH0gPSBzZXR1cCgnYmlucycsIGksIGVuY29kaW5ncyk7XG4gICAgICAgIHRlc3RSZW5kZXIoYGJpbnNfJHtpbk91dH0tMGApO1xuXG4gICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCdiaW5zJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgY29uc3QgeW5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHluZXdbMF0sIHlvbGRbMF0pO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeW5ld1sxXSwgeW9sZFsxXSk7XG4gICAgICAgIHRlc3RSZW5kZXIoYGJpbnNfJHtpbk91dH0tMWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCB3b3JrIHdpdGggdGVtcG9yYWwgZG9tYWlucycsIGZ1bmN0aW9uKCkge1xuICAgICAgY29uc3QgdmFsdWVzID0gdHVwbGVzLm1hcCgoZCkgPT4gKHsuLi5kLCBhOiBuZXcgRGF0ZSgyMDE3LCBkLmEpfSkpO1xuICAgICAgY29uc3QgZW5jb2RpbmdzID0gWyd4J107XG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGl0cy56b29tLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGVtYmVkKHNwZWMoJ3VuaXQnLCBpLCB7dHlwZSwgLi4uYmluZGluZywgZW5jb2RpbmdzfSxcbiAgICAgICAgICB7dmFsdWVzLCB4OiB7dHlwZTogJ3RlbXBvcmFsJ319KSk7XG4gICAgICAgIGNvbnN0IHtpbk91dCwgeG9sZH0gPSBzZXR1cCgnZHJhZycsIGksIGVuY29kaW5ncyk7XG4gICAgICAgIHRlc3RSZW5kZXIoYHRlbXBvcmFsXyR7aW5PdXR9LTBgKTtcblxuICAgICAgICBjb25zdCB6b29tZWQgPSBicm93c2VyLmV4ZWN1dGUoem9vbSgnem9vbScsIGksIGluT3V0LCBudWxsLCBiaW5kID09PSB1bmJvdW5kKSkudmFsdWVbMF07XG4gICAgICAgIGNvbnN0IHhuZXcgPSB6b29tZWQuaW50ZXJ2YWxzWzBdLmV4dGVudC5zb3J0KGNtcCk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzBdXSgreG5ld1swXSwgKyhuZXcgRGF0ZSh4b2xkWzBdKSkpO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oK3huZXdbMV0sICsobmV3IERhdGUoeG9sZFsxXSkpKTtcbiAgICAgICAgdGVzdFJlbmRlcihgdGVtcG9yYWxfJHtpbk91dH0tMWApO1xuICAgICAgfVxuXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHdvcmsgd2l0aCBsb2cvcG93IHNjYWxlcycsIGZ1bmN0aW9uKCkge1xuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBoaXRzLnpvb20ubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgZW1iZWQoc3BlYygndW5pdCcsIGksIHt0eXBlLCAuLi5iaW5kaW5nfSwge1xuICAgICAgICAgIHg6IHtzY2FsZToge3R5cGU6ICdwb3cnLCBleHBvbmVudDogMS41fX0sXG4gICAgICAgICAgeToge3NjYWxlOiB7dHlwZTogJ2xvZyd9fVxuICAgICAgICB9KSk7XG4gICAgICAgIGNvbnN0IHtpbk91dCwgeG9sZCwgeW9sZH0gPSBzZXR1cCgnZHJhZycsIGksIFsneCcsICd5J10pO1xuICAgICAgICB0ZXN0UmVuZGVyKGBsb2dwb3dfJHtpbk91dH0tMGApO1xuXG4gICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCd6b29tJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgY29uc3QgeG5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgY29uc3QgeW5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMV0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHhuZXdbMF0sIHhvbGRbMF0pO1xuICAgICAgICBhc3NlcnRbYXNzZXJ0RXh0ZW50W2luT3V0XVsxXV0oeG5ld1sxXSwgeG9sZFsxXSk7XG4gICAgICAgIGFzc2VydFthc3NlcnRFeHRlbnRbaW5PdXRdWzBdXSh5bmV3WzBdLCB5b2xkWzBdKTtcbiAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMV1dKHluZXdbMV0sIHlvbGRbMV0pO1xuICAgICAgICB0ZXN0UmVuZGVyKGBsb2dwb3dfJHtpbk91dH0tMWApO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgaWYgKGJpbmQgPT09IHVuYm91bmQpIHtcbiAgICAgIGl0KCdzaG91bGQgd29yayB3aXRoIG9yZGluYWwvbm9taW5hbCBkb21haW5zJywgZnVuY3Rpb24oKSB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGl0cy56b29tLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgZW1iZWQoc3BlYygndW5pdCcsIGksIHt0eXBlLCAuLi5iaW5kaW5nfSwge1xuICAgICAgICAgICAgeDoge3R5cGU6ICdvcmRpbmFsJ30sIHk6IHt0eXBlOiAnbm9taW5hbCd9XG4gICAgICAgICAgfSkpO1xuICAgICAgICAgIGNvbnN0IHtpbk91dCwgeG9sZCwgeW9sZH0gPSBzZXR1cCgnZHJhZycsIGksIFsneCcsICd5J10pO1xuICAgICAgICAgIHRlc3RSZW5kZXIoYG9yZF8ke2luT3V0fS0wYCk7XG5cbiAgICAgICAgICBjb25zdCB6b29tZWQgPSBicm93c2VyLmV4ZWN1dGUoem9vbSgnem9vbScsIGksIGluT3V0LCBudWxsLCBiaW5kID09PSB1bmJvdW5kKSkudmFsdWVbMF07XG4gICAgICAgICAgY29uc3QgeG5ldyA9IHpvb21lZC5pbnRlcnZhbHNbMF0uZXh0ZW50LnNvcnQoY21wKTtcbiAgICAgICAgICBjb25zdCB5bmV3ID0gem9vbWVkLmludGVydmFsc1sxXS5leHRlbnQuc29ydChjbXApO1xuXG4gICAgICAgICAgaWYgKGluT3V0ID09PSAnaW4nKSB7XG4gICAgICAgICAgICBhc3NlcnQuaXNBdE1vc3QoeG5ldy5sZW5ndGgsIHhvbGQubGVuZ3RoKTtcbiAgICAgICAgICAgIGFzc2VydC5pc0F0TW9zdCh5bmV3Lmxlbmd0aCwgeW9sZC5sZW5ndGgpO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBhc3NlcnQuaXNBdExlYXN0KHhuZXcubGVuZ3RoLCB4b2xkLmxlbmd0aCk7XG4gICAgICAgICAgICBhc3NlcnQuaXNBdExlYXN0KHluZXcubGVuZ3RoLCB5b2xkLmxlbmd0aCk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdGVzdFJlbmRlcihgb3JkXyR7aW5PdXR9LTFgKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbXBvc2l0ZVR5cGVzLmZvckVhY2goZnVuY3Rpb24oc3BlY1R5cGUpIHtcbiAgICAgICAgaXQoYHNob3VsZCB3b3JrIHdpdGggc2hhcmVkIHNjYWxlcyBpbiAke3NwZWNUeXBlfSB2aWV3c2AsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgaGl0cy5iaW5zLmxlbmd0aDsgaSsrKSB7XG4gICAgICAgICAgICBlbWJlZChzcGVjKHNwZWNUeXBlLCAwLCB7dHlwZSwgLi4uYmluZGluZ30sXG4gICAgICAgICAgICAgIHtyZXNvbHZlOiB7c2NhbGU6IHt4OiAnc2hhcmVkJywgeTogJ3NoYXJlZCd9fX0pKTtcbiAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IHBhcmVudFNlbGVjdG9yKHNwZWNUeXBlLCBpKTtcbiAgICAgICAgICAgIGNvbnN0IHtpbk91dCwgeG9sZCwgeW9sZH0gPSBzZXR1cChzcGVjVHlwZSwgaSwgWyd4JywgJ3knXSwgcGFyZW50KTtcbiAgICAgICAgICAgIGNvbnN0IHpvb21lZCA9IGJyb3dzZXIuZXhlY3V0ZSh6b29tKCdiaW5zJywgaSwgaW5PdXQsIG51bGwsIGJpbmQgPT09IHVuYm91bmQpKS52YWx1ZVswXTtcbiAgICAgICAgICAgIGNvbnN0IHhuZXcgPSB6b29tZWQuaW50ZXJ2YWxzWzBdLmV4dGVudC5zb3J0KGNtcCk7XG4gICAgICAgICAgICBjb25zdCB5bmV3ID0gem9vbWVkLmludGVydmFsc1sxXS5leHRlbnQuc29ydChjbXApO1xuICAgICAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHhuZXdbMF0sIHhvbGRbMF0pO1xuICAgICAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMV1dKHhuZXdbMV0sIHhvbGRbMV0pO1xuICAgICAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMF1dKHluZXdbMF0sIHlvbGRbMF0pO1xuICAgICAgICAgICAgYXNzZXJ0W2Fzc2VydEV4dGVudFtpbk91dF1bMV1dKHluZXdbMV0sIHlvbGRbMV0pO1xuICAgICAgICAgICAgdGVzdFJlbmRlcihgJHtzcGVjVHlwZX1fJHtpbk91dH1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfVxuICB9KTtcbn0pO1xuIl19